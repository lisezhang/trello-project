<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Trello Clone avec Carte</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;overflow-x:auto
    }

    .navbar{
      background-color:rgba(0,0,0,.6);
      color:#fff;padding:15px 20px;
      display:flex;justify-content:space-between;align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      position:sticky;top:0;z-index:100
    }
    .navbar-brand{font-size:24px;font-weight:700;display:flex;align-items:center;gap:10px}
    .navbar-controls{display:flex;gap:15px;align-items:center;flex-wrap:wrap}

    .btn{
      padding:8px 16px;border:none;border-radius:4px;cursor:pointer;
      font-size:14px;transition:all .2s ease
    }
    .btn-primary{background:#667eea;color:#fff}
    .btn-primary:hover{background:#5568d3}
    .btn-secondary{background:#555;color:#fff}
    .btn-secondary:hover{background:#666}
    .btn-danger{background:#e74c3c;color:#fff}
    .btn-danger:hover{background:#c0392b}

    .view-toggle{display:flex;gap:5px}
    .view-toggle button{
      padding:6px 12px;font-size:12px;background:rgba(255,255,255,.2);
      color:#fff;border:1px solid #fff;border-radius:4px;cursor:pointer;
      transition:all .2s
    }
    .view-toggle button.active{background:#667eea;border-color:#667eea}

    .container{display:flex;height:calc(100vh - 60px);gap:0}

    .board-section{flex:1;display:none;flex-direction:column;overflow:hidden}
    .board-section.active{display:flex}
    .board-content{
      flex:1;display:flex;gap:20px;padding:20px;
      overflow-x:auto;overflow-y:auto
    }

    .list-container{
      background:#ebecf0;border-radius:3px;padding:15px;
      min-width:272px;max-width:272px;display:flex;flex-direction:column;flex-shrink:0;
      max-height:calc(100vh - 120px)
    }
    .list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
    .list-title{
      font-weight:700;color:#333;font-size:14px;flex:1;cursor:pointer;padding:5px;border-radius:3px;
      transition:all .2s
    }
    .list-title:hover{background:rgba(0,0,0,.1)}
    .list-title-input{width:100%;padding:5px;border:1px solid #ccc;border-radius:3px;font-size:14px;font-weight:700}
    .list-actions{display:flex;gap:5px}
    .list-action-btn{
      background:none;border:none;color:#333;cursor:pointer;font-size:14px;padding:4px 8px;border-radius:3px;
      transition:all .2s
    }
    .list-action-btn:hover{background:rgba(0,0,0,.1)}

    .cards-container{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
    .cards-container.drag-over{background:#f0f0f0;border-radius:3px}

    .card{
      background:#fff;padding:12px;border-radius:3px;
      box-shadow:0 1px 3px rgba(0,0,0,.12);
      cursor:pointer;transition:all .2s;margin-bottom:5px
    }
    .card:hover{box-shadow:0 2px 5px rgba(0,0,0,.15)}
    .card.dragging{opacity:.5}
    .card-title{font-size:14px;color:#333;margin-bottom:5px;font-weight:500}
    .card-labels{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px}
    .label{font-size:11px;padding:3px 6px;border-radius:12px;color:#fff;font-weight:600}
    .card-info{display:flex;gap:8px;font-size:12px;color:#666;flex-wrap:wrap}
    .card-info-item{display:flex;align-items:center;gap:3px}

    .add-list-btn{
      background:rgba(0,0,0,.12);padding:15px;border-radius:3px;min-width:272px;color:#fff;cursor:pointer;
      text-align:center;transition:all .2s
    }
    .add-list-btn:hover{background:rgba(0,0,0,.25)}

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{
      background:#fff;padding:30px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.3);
      width:90%;max-width:600px;max-height:85vh;overflow-y:auto
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .close-modal{font-size:28px;font-weight:700;color:#aaa;cursor:pointer;background:none;border:none;padding:0}
    .close-modal:hover{color:#000}

    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600;color:#333}
    .form-group input,.form-group textarea,.form-group select{
      width:100%;padding:10px;border:1px solid #ccc;border-radius:4px;font-size:14px;font-family:inherit
    }
    .form-group textarea{resize:vertical;min-height:80px}
    .form-group input:focus,.form-group textarea:focus{
      outline:none;border-color:#667eea;box-shadow:0 0 5px rgba(102,126,234,.3)
    }

    .modal-buttons{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
    .modal-buttons button{flex:1;min-width:120px;padding:10px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:all .2s}
    .btn-save{background:#667eea;color:#fff}
    .btn-save:hover{background:#5568d3}
    .btn-cancel{background:#ccc;color:#333}
    .btn-cancel:hover{background:#bbb}

    .color-picker{display:flex;gap:10px;flex-wrap:wrap}
    .color-option{width:30px;height:30px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:all .2s}
    .color-option.selected{border-color:#333;transform:scale(1.1)}

    .map-section{flex:1;display:none;flex-direction:column;overflow:hidden}
    .map-section.active{display:flex}
    #map{flex:1;border-radius:3px}
    .map-controls{
      background:rgba(0,0,0,.6);color:#fff;padding:15px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .map-controls input{padding:8px 12px;border:none;border-radius:4px;font-size:14px;width:220px}

    .autocomplete-list{
      position:absolute;background:#fff;border:1px solid #ccc;border-radius:3px;
      max-height:200px;overflow-y:auto;z-index:999;width:calc(100% - 20px);margin-top:-10px
    }
    .autocomplete-item{padding:10px;cursor:pointer;border-bottom:1px solid #eee;font-size:13px}
    .autocomplete-item:hover{background:#f0f0f0}
    .form-group-relative{position:relative}

    /* D√©tail carte */
    .card-detail-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #eee}
    .card-detail-section:last-child{border-bottom:none}
    .card-detail-field{margin-bottom:15px}
    .card-detail-field label{font-weight:700;color:#333;display:block;margin-bottom:5px;font-size:13px}
    .card-detail-value{
      padding:10px;background:#f5f5f5;border-radius:3px;cursor:pointer;transition:all .2s;
      border:1px solid transparent;min-height:30px;display:flex;align-items:center
    }
    .card-detail-value:hover{background:#eee;border-color:#ccc}
    .card-detail-value.empty{color:#999;font-style:italic}
    .card-detail-input{width:100%;padding:10px;border:1px solid #667eea;border-radius:3px;font-size:14px}

    .checklist-item{
      display:flex;align-items:center;gap:10px;padding:8px;background:#f9f9f9;border-radius:3px;margin-bottom:5px
    }
    .checklist-item input[type="checkbox"]{cursor:pointer}
    .checklist-item-text{flex:1;word-break:break-word}
    .checklist-item-delete{background:none;border:none;color:#e74c3c;cursor:pointer;font-size:12px}
    .checklist-item-delete:hover{text-decoration:underline}
    .add-checklist-item{
      padding:8px;border:1px dashed #ccc;border-radius:3px;text-align:center;cursor:pointer;color:#666;transition:all .2s
    }
    .add-checklist-item:hover{background:#f5f5f5;border-color:#999}

    .history-item{
      padding:10px;background:#f9f9f9;border-radius:3px;margin-bottom:8px;font-size:13px;border-left:3px solid #667eea
    }
    .history-time{color:#999;font-size:12px}
    .history-action{color:#333;margin-top:3px}

    /* Mini-carte */
    #detailMiniMapContainer{margin-top:10px;border-radius:4px;overflow:hidden;border:1px solid #ddd}
    #detailMiniMap{width:100%;height:250px}

    @media (max-width:768px){
      .container{flex-direction:column}
      .board-content{flex-direction:column}
      .list-container{min-width:100%;max-width:100%}
      .modal-content{max-width:95%}
    }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="navbar-brand">
      <i class="fas fa-trello"></i>
      Trello Clone
    </div>

    <div class="navbar-controls">
      <div class="view-toggle">
        <button id="btnViewBoard" class="active" onclick="switchView('board')">
          <i class="fas fa-th"></i> Board
        </button>
        <button id="btnViewMap" onclick="switchView('map')">
          <i class="fas fa-map"></i> Map
        </button>
      </div>

      <button class="btn btn-primary" onclick="openAddListModal()">
        <i class="fas fa-plus"></i> Ajouter une liste
      </button>

      <button class="btn btn-danger" onclick="deleteAllCards()">
        <i class="fas fa-trash"></i> Supprimer toutes les cartes
      </button>
    </div>
  </div>

  <div class="container">
    <div class="board-section active" id="boardSection">
      <div class="board-content" id="boardContent">
        <div class="add-list-btn" onclick="openAddListModal()">
          <i class="fas fa-plus"></i> Ajouter une liste
        </div>
      </div>
    </div>

    <div class="map-section" id="mapSection">
      <div id="map"></div>
      <div class="map-controls">
        <input type="text" id="searchInput" placeholder="Rechercher un lieu...">
        <button class="btn btn-primary" onclick="fitMapToMarkers(true)">
          <i class="fas fa-crosshairs"></i> Recentrer sur les marqueurs
        </button>
        <button class="btn btn-secondary" onclick="clearMapMarkersOnly()">
          <i class="fas fa-eraser"></i> Masquer les marqueurs (visuel)
        </button>
      </div>
    </div>
  </div>

  <!-- Add List Modal -->
  <div class="modal" id="addListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ajouter une liste</h2>
        <button class="close-modal" onclick="closeAddListModal()">&times;</button>
      </div>
      <div class="form-group">
        <label for="listNameInput">Nom de la liste:</label>
        <input type="text" id="listNameInput" placeholder="Entrez le nom de la liste">
      </div>
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveNewList()">Cr√©er</button>
        <button class="btn-cancel" onclick="closeAddListModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Delete List Modal -->
  <div class="modal" id="deleteListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Supprimer la liste</h2>
        <button class="close-modal" onclick="closeDeleteListModal()">&times;</button>
      </div>
      <p id="deleteListMessage" style="margin-bottom: 20px;"></p>
      <div class="modal-buttons">
        <button class="btn-save" onclick="moveCardsToArchives()">D√©placer vers Archives</button>
        <button class="btn-danger" onclick="deleteCardsAndList()">Supprimer toutes les cartes</button>
        <button class="btn-cancel" onclick="closeDeleteListModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Add Card Modal -->
  <div class="modal" id="addCardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="cardModalTitle">Ajouter une carte</h2>
        <button class="close-modal" onclick="closeAddCardModal()">&times;</button>
      </div>

      <div class="form-group">
        <label for="cardTitleInput">Titre de la carte:</label>
        <input type="text" id="cardTitleInput" placeholder="Entrez le titre de la carte">
      </div>

      <div class="form-group">
        <label for="cardDescriptionInput">Description:</label>
        <textarea id="cardDescriptionInput" placeholder="Entrez la description"></textarea>
      </div>

      <div class="form-group">
        <label>√âtiquettes:</label>
        <div class="color-picker" id="labelPicker">
          <div class="color-option" style="background-color:#FF6B6B" onclick="toggleColor(this,'#FF6B6B')"></div>
          <div class="color-option" style="background-color:#FFA500" onclick="toggleColor(this,'#FFA500')"></div>
          <div class="color-option" style="background-color:#FFD93D" onclick="toggleColor(this,'#FFD93D')"></div>
          <div class="color-option" style="background-color:#6BCB77" onclick="toggleColor(this,'#6BCB77')"></div>
          <div class="color-option" style="background-color:#4D96FF" onclick="toggleColor(this,'#4D96FF')"></div>
          <div class="color-option" style="background-color:#9D4EDD" onclick="toggleColor(this,'#9D4EDD')"></div>
          <div class="color-option" style="background-color:#FF006E" onclick="toggleColor(this,'#FF006E')"></div>
          <div class="color-option" style="background-color:#00F5FF" onclick="toggleColor(this,'#00F5FF')"></div>
        </div>
      </div>

      <div class="form-group form-group-relative">
        <label for="cardAddressInput">Adresse (optionnel):</label>
        <input type="text" id="cardAddressInput" placeholder="Entrez une adresse" autocomplete="off" oninput="searchAddress(this.value)">
        <div id="addressAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>

      <div class="form-group">
        <label for="cardDueDateInput">Date d'√©ch√©ance:</label>
        <input type="date" id="cardDueDateInput">
      </div>

      <div class="modal-buttons">
        <button class="btn-save" onclick="saveNewCard()">Cr√©er</button>
        <button class="btn-cancel" onclick="closeAddCardModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Card Detail Modal -->
  <div class="modal" id="cardDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="detailCardTitle">D√©tails de la carte</h2>
        <button class="close-modal" onclick="closeCardDetailModal()">&times;</button>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Titre</label>
          <div class="card-detail-value" id="detailTitle" onclick="editCardField('title')"></div>
          <input type="text" class="card-detail-input" id="detailTitleInput" style="display:none;" onkeydown="saveCardField(event,'title')">
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Description</label>
          <div class="card-detail-value" id="detailDescription" onclick="editCardField('description')"></div>
          <textarea class="card-detail-input" id="detailDescriptionInput" style="display:none;min-height:100px;"
            onkeydown="saveCardField(event,'description')"
            onblur="saveCardField({type:'blur'},'description')"></textarea>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>√âtiquettes</label>
          <div class="card-detail-value" id="detailLabels" onclick="editCardField('labels')" style="flex-wrap:wrap;gap:5px;"></div>
          <div id="detailLabelsInput" style="display:none;">
            <div class="color-picker">
              <div class="color-option" style="background-color:#FF6B6B" onclick="toggleDetailColor(this,'#FF6B6B')"></div>
              <div class="color-option" style="background-color:#FFA500" onclick="toggleDetailColor(this,'#FFA500')"></div>
              <div class="color-option" style="background-color:#FFD93D" onclick="toggleDetailColor(this,'#FFD93D')"></div>
              <div class="color-option" style="background-color:#6BCB77" onclick="toggleDetailColor(this,'#6BCB77')"></div>
              <div class="color-option" style="background-color:#4D96FF" onclick="toggleDetailColor(this,'#4D96FF')"></div>
              <div class="color-option" style="background-color:#9D4EDD" onclick="toggleDetailColor(this,'#9D4EDD')"></div>
              <div class="color-option" style="background-color:#FF006E" onclick="toggleDetailColor(this,'#FF006E')"></div>
              <div class="color-option" style="background-color:#00F5FF" onclick="toggleDetailColor(this,'#00F5FF')"></div>
            </div>
            <button class="btn btn-primary" style="margin-top:10px;width:100%;" onclick="saveCardField(null,'labels')">Valider</button>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Date d'√©ch√©ance</label>
          <div class="card-detail-value" id="detailDate" onclick="editCardField('dueDate')"></div>
          <input type="date" class="card-detail-input" id="detailDateInput" style="display:none;"
                 onkeydown="saveCardField(event,'dueDate')"
                 onblur="saveCardField({type:'blur'},'dueDate')">
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Adresse</label>
          <div class="card-detail-value" id="detailAddress" onclick="editCardField('address')" style="word-break:break-word;"></div>
          <div class="form-group-relative">
            <input type="text" class="card-detail-input" id="detailAddressInput" style="display:none;" autocomplete="off"
                   onkeydown="saveCardField(event,'address')" oninput="searchDetailAddress(this.value)">
            <div id="detailAddressAutocomplete" class="autocomplete-list" style="display:none;"></div>
          </div>

          <div id="detailMiniMapContainer" style="display:none;">
            <div id="detailMiniMap"></div>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <label style="font-weight:700;color:#333;font-size:14px;">Checklist</label>
        <div class="checklist-section" id="checklistContainer"></div>
        <div class="add-checklist-item" onclick="addChecklistItem()">+ Ajouter un item</div>
      </div>

      <div class="card-detail-section">
        <label style="font-weight:700;color:#333;font-size:14px;">Historique</label>
        <div id="historyContainer" style="max-height:250px;overflow-y:auto;"></div>
      </div>

      <div class="modal-buttons">
        <button class="btn-danger" onclick="deleteCard()" style="flex:1;">Supprimer la carte</button>
        <button class="btn-cancel" onclick="closeCardDetailModal()" style="flex:1;">Fermer</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // -------------------------
    // Etat + constantes
    // -------------------------
    let currentListId = null;
    let currentCardId = null;

    let selectedLabels = [];
    let detailSelectedLabels = [];

    let map = null;
    let markers = {};               // markers[cardId] = L.marker
    let markersLayer = null;        // L.layerGroup for big map markers
    let markersHidden = false;

    let addressSearchTimeout = null;
    let detailAddressSearchTimeout = null;

    // Mini-map
    let detailMiniMap = null;
    let detailMiniMarkersLayer = null;
    let detailMiniCurrentMarker = null;

    // Persisted UI
    const STORAGE_ACTIVE_VIEW = 'trelloActiveView';
    const STORAGE_MAP_VIEW = 'trelloMapView'; // {lat,lng,zoom}

    // Map defaults
    const DEFAULT_MAP_CENTER = [48.8566, 2.3522]; // Paris
    const DEFAULT_MAP_ZOOM = 6;
    const FIT_PADDING = [40, 40];
    const FIT_MAX_ZOOM = 14;

    // Pour d√©clencher fitBounds uniquement quand on repasse de 0 -> >0 marqueurs
    let lastMarkerCount = 0;

    const labelColors = {
      '#FF6B6B': 'Rouge',
      '#FFA500': 'Orange',
      '#FFD93D': 'Jaune',
      '#6BCB77': 'Vert',
      '#4D96FF': 'Bleu',
      '#9D4EDD': 'Violet',
      '#FF006E': 'Rose',
      '#00F5FF': 'Cyan'
    };

    let lists = [];
    let cards = [];

    // -------------------------
    // Init
    // -------------------------
    function init() {
      loadData();

      // Si premi√®re ouverture: on cr√©e juste les listes, mais PAS de cartes de d√©mo
      if (lists.length === 0) {
        lists = [
          { id: 1, title: '√Ä faire' },
          { id: 2, title: 'En cours' },
          { id: 3, title: 'Termin√©' }
        ];
        cards = [];
        saveData();
      }

      renderBoard();
      initMap();

      // Marqueurs charg√©s "en amont"
      renderMapMarkers({ fit: true, reason: 'init' });

      // Restaurer la derni√®re vue (board/map)
      restoreLastView();
    }

    function loadData() {
      const savedLists = localStorage.getItem('trelloLists');
      const savedCards = localStorage.getItem('trelloCards');
      if (savedLists) lists = JSON.parse(savedLists);
      if (savedCards) cards = JSON.parse(savedCards);
    }

    function saveData() {
      localStorage.setItem('trelloLists', JSON.stringify(lists));
      localStorage.setItem('trelloCards', JSON.stringify(cards));
    }

    // -------------------------
    // Board rendering
    // -------------------------
    function renderBoard() {
      const boardContent = document.getElementById('boardContent');
      boardContent.innerHTML = '';

      lists.forEach(list => {
        const listDiv = createListElement(list);
        boardContent.appendChild(listDiv);
      });

      const addListDiv = document.createElement('div');
      addListDiv.className = 'add-list-btn';
      addListDiv.innerHTML = '<i class="fas fa-plus"></i> Ajouter une liste';
      addListDiv.onclick = openAddListModal;
      boardContent.appendChild(addListDiv);
    }

    function createListElement(list) {
      const listContainer = document.createElement('div');
      listContainer.className = 'list-container';
      listContainer.id = `list-${list.id}`;

      const listHeader = document.createElement('div');
      listHeader.className = 'list-header';

      const listTitle = document.createElement('div');
      listTitle.className = 'list-title';
      listTitle.textContent = list.title;
      listTitle.onclick = () => enableEditListTitle(listTitle, list);

      const listActions = document.createElement('div');
      listActions.className = 'list-actions';

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'list-action-btn';
      deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
      deleteBtn.onclick = () => openDeleteListModal(list);

      listActions.appendChild(deleteBtn);
      listHeader.appendChild(listTitle);
      listHeader.appendChild(listActions);

      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'cards-container';
      cardsContainer.id = `cards-${list.id}`;
      cardsContainer.ondragover = (e) => handleDragOver(e, list.id);
      cardsContainer.ondrop = (e) => handleDrop(e, list.id);
      cardsContainer.ondragleave = handleDragLeave;

      cards.filter(c => c.listId === list.id).forEach(card => {
        cardsContainer.appendChild(createCardElement(card));
      });

      const addCardButton = document.createElement('button');
      addCardButton.className = 'btn btn-secondary';
      addCardButton.style.width = '100%';
      addCardButton.innerHTML = '<i class="fas fa-plus"></i> Ajouter une carte';
      addCardButton.onclick = () => {
        currentListId = list.id;
        currentCardId = null;
        openAddCardModal();
      };

      listContainer.appendChild(listHeader);
      listContainer.appendChild(cardsContainer);
      listContainer.appendChild(addCardButton);

      return listContainer;
    }

    function enableEditListTitle(titleElement, list) {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'list-title-input';
      input.value = list.title;

      titleElement.replaceWith(input);
      input.focus();
      input.select();

      function saveTitle() {
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== list.title) {
          list.title = newTitle;
          saveData();
        }
        renderBoard();
      }

      input.onblur = saveTitle;
      input.onkeydown = (e) => {
        if (e.key === 'Enter') saveTitle();
        if (e.key === 'Escape') renderBoard();
      };
    }

    function createCardElement(card) {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.draggable = true;
      cardDiv.id = `card-${card.id}`;
      cardDiv.ondragstart = handleDragStart;
      cardDiv.ondragend = handleDragEnd;

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = card.title;

      const labelsDiv = document.createElement('div');
      labelsDiv.className = 'card-labels';
      (card.labels || []).forEach(labelColor => {
        const label = document.createElement('div');
        label.className = 'label';
        label.style.backgroundColor = labelColor;
        label.textContent = labelColors[labelColor] || 'Label';
        labelsDiv.appendChild(label);
      });

      const infoDiv = document.createElement('div');
      infoDiv.className = 'card-info';

      if (card.dueDate) {
        const dateItem = document.createElement('div');
        dateItem.className = 'card-info-item';
        dateItem.innerHTML = `<i class="fas fa-calendar"></i> ${card.dueDate}`;
        infoDiv.appendChild(dateItem);
      }

      cardDiv.appendChild(title);
      cardDiv.appendChild(labelsDiv);
      cardDiv.appendChild(infoDiv);

      cardDiv.onclick = () => openCardDetailModal(card);

      return cardDiv;
    }

    // -------------------------
    // Drag & drop
    // -------------------------
    let draggedCard = null;

    function handleDragStart(e) {
      draggedCard = e.target.closest('.card');
      draggedCard.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd() {
      if (draggedCard) draggedCard.classList.remove('dragging');
      draggedCard = null;
      document.querySelectorAll('.cards-container').forEach(c => c.classList.remove('drag-over'));
    }

    function handleDragOver(e, listId) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.getElementById(`cards-${listId}`).classList.add('drag-over');
    }

    function handleDragLeave(e) {
      if (e.target.classList.contains('cards-container')) {
        e.target.classList.remove('drag-over');
      }
    }

    function handleDrop(e, listId) {
      e.preventDefault();
      e.target.closest('.cards-container').classList.remove('drag-over');
      if (!draggedCard) return;

      const cardId = parseInt(draggedCard.id.replace('card-', ''), 10);
      const card = cards.find(c => c.id === cardId);
      if (!card) return;

      card.listId = listId;
      saveData();
      renderBoard();
      // Les marqueurs ne d√©pendent pas du listId, donc pas besoin de fit
      renderMapMarkers({ fit: false, reason: 'drag' });
    }

    // -------------------------
    // Modals - lists
    // -------------------------
    function openAddListModal() {
      document.getElementById('addListModal').classList.add('show');
      document.getElementById('listNameInput').focus();
    }

    function closeAddListModal() {
      document.getElementById('addListModal').classList.remove('show');
      document.getElementById('listNameInput').value = '';
    }

    function saveNewList() {
      const listName = document.getElementById('listNameInput').value.trim();
      if (!listName) return alert('Veuillez entrer un nom de liste');

      const newList = { id: Math.max(...lists.map(l => l.id), 0) + 1, title: listName };
      lists.push(newList);
      saveData();
      renderBoard();
      closeAddListModal();
    }

    function openDeleteListModal(list) {
      const listCards = cards.filter(card => card.listId === list.id);
      document.getElementById('deleteListMessage').innerHTML =
        `<strong>${list.title}</strong> contient ${listCards.length} carte(s). Que souhaitez-vous faire ?`;
      document.getElementById('deleteListModal').setAttribute('data-list-id', list.id);
      document.getElementById('deleteListModal').classList.add('show');
    }

    function closeDeleteListModal() {
      document.getElementById('deleteListModal').classList.remove('show');
    }

    function moveCardsToArchives() {
      const listId = parseInt(document.getElementById('deleteListModal').getAttribute('data-list-id'), 10);
      let archivesList = lists.find(l => l.title === 'Archives');

      if (!archivesList) {
        archivesList = { id: Math.max(...lists.map(l => l.id), 0) + 1, title: 'Archives' };
        lists.push(archivesList);
      }

      cards.filter(c => c.listId === listId).forEach(card => { card.listId = archivesList.id; });
      lists = lists.filter(l => l.id !== listId);

      saveData();
      renderBoard();
      renderMapMarkers({ fit: true, reason: 'archive' });
      closeDeleteListModal();
    }

    function deleteCardsAndList() {
      const listId = parseInt(document.getElementById('deleteListModal').getAttribute('data-list-id'), 10);
      cards = cards.filter(c => c.listId !== listId);
      lists = lists.filter(l => l.id !== listId);

      saveData();
      renderBoard();
      renderMapMarkers({ fit: true, reason: 'deleteList' });
      closeDeleteListModal();
    }

    // -------------------------
    // Modals - cards
    // -------------------------
    function openAddCardModal() {
      selectedLabels = [];
      document.getElementById('cardModalTitle').textContent = 'Ajouter une carte';
      document.getElementById('cardTitleInput').value = '';
      document.getElementById('cardDescriptionInput').value = '';
      document.getElementById('cardAddressInput').value = '';
      document.getElementById('cardDueDateInput').value = '';
      document.querySelectorAll('#labelPicker .color-option').forEach(el => el.classList.remove('selected'));
      document.getElementById('addressAutocomplete').style.display = 'none';
      window.currentAddressCoordinates = null;

      document.getElementById('addCardModal').classList.add('show');
      document.getElementById('cardTitleInput').focus();
    }

    function closeAddCardModal() {
      document.getElementById('addCardModal').classList.remove('show');
      document.getElementById('addressAutocomplete').style.display = 'none';
    }

    function toggleColor(element, color) {
      element.classList.toggle('selected');
      const idx = selectedLabels.indexOf(color);
      if (idx > -1) selectedLabels.splice(idx, 1);
      else selectedLabels.push(color);
    }

    function saveNewCard() {
      const title = document.getElementById('cardTitleInput').value.trim();
      if (!title) return alert('Veuillez entrer un titre');

      const newCard = {
        id: Math.max(...cards.map(c => c.id), 0) + 1,
        listId: currentListId,
        title,
        description: document.getElementById('cardDescriptionInput').value,
        labels: selectedLabels,
        address: document.getElementById('cardAddressInput').value.trim(),
        coordinates: window.currentAddressCoordinates || null,
        dueDate: document.getElementById('cardDueDateInput').value,
        checklist: [],
        history: [{ action: 'Carte cr√©√©e', timestamp: new Date().toLocaleString('fr-FR') }],
        createdAt: new Date().toLocaleString('fr-FR')
      };

      cards.push(newCard);
      window.currentAddressCoordinates = null;

      saveData();
      renderBoard();

      // Nouveau point => fitBounds auto (notamment si on √©tait √† 0 marqueur)
      renderMapMarkers({ fit: true, reason: 'createCard' });

      closeAddCardModal();
    }

    // -------------------------
    // Card detail modal
    // -------------------------
    function openCardDetailModal(card) {
      currentCardId = card.id;
      detailSelectedLabels = [...(card.labels || [])];

      document.getElementById('detailCardTitle').textContent = card.title;

      document.getElementById('detailTitle').textContent = card.title;
      document.getElementById('detailTitleInput').value = card.title;

      document.getElementById('detailDescription').textContent = card.description || '(Vide)';
      document.getElementById('detailDescription').className = card.description ? 'card-detail-value' : 'card-detail-value empty';
      document.getElementById('detailDescriptionInput').value = card.description || '';

      document.getElementById('detailDate').textContent = card.dueDate || '(Pas de date)';
      document.getElementById('detailDate').className = card.dueDate ? 'card-detail-value' : 'card-detail-value empty';
      document.getElementById('detailDateInput').value = card.dueDate || '';

      document.getElementById('detailAddress').textContent = card.address || '(Aucune adresse)';
      document.getElementById('detailAddress').className = card.address ? 'card-detail-value' : 'card-detail-value empty';
      document.getElementById('detailAddressInput').value = card.address || '';
      document.getElementById('detailAddressAutocomplete').style.display = 'none';

      renderDetailLabels(card);
      renderChecklist(card);
      renderHistory(card);

      document.getElementById('cardDetailModal').classList.add('show');

      // Mini-map apr√®s affichage du modal
      setTimeout(() => initOrUpdateDetailMiniMap(card), 300);
    }

    function closeCardDetailModal() {
      document.getElementById('cardDetailModal').classList.remove('show');
      currentCardId = null;
    }

    function renderDetailLabels(card) {
      const labelsContainer = document.getElementById('detailLabels');
      labelsContainer.innerHTML = '';

      if (card.labels && card.labels.length > 0) {
        card.labels.forEach(labelColor => {
          const label = document.createElement('div');
          label.className = 'label';
          label.style.backgroundColor = labelColor;
          label.textContent = labelColors[labelColor] || 'Label';
          labelsContainer.appendChild(label);
        });
        labelsContainer.className = 'card-detail-value';
      } else {
        labelsContainer.textContent = '(Aucune √©tiquette)';
        labelsContainer.className = 'card-detail-value empty';
      }

      document.querySelectorAll('#detailLabelsInput .color-option').forEach(el => el.classList.remove('selected'));
      (card.labels || []).forEach(color => {
        document.querySelectorAll('#detailLabelsInput .color-option').forEach(el => {
          // NB: comparaison via style backgroundColor est fragile; on s‚Äôen sert juste visuellement ici
          // Le mod√®le de donn√©e est fiable.
          if (rgbToHex(el.style.backgroundColor) === color.toLowerCase()) el.classList.add('selected');
        });
      });
    }

    function rgbToHex(rgb) {
      if (!rgb) return '';
      if (rgb.startsWith('#')) return rgb.toLowerCase();
      const m = rgb.match(/\d+/g);
      if (!m) return '';
      const r = parseInt(m[0], 10).toString(16).padStart(2,'0');
      const g = parseInt(m[1], 10).toString(16).padStart(2,'0');
      const b = parseInt(m[2], 10).toString(16).padStart(2,'0');
      return `#${r}${g}${b}`.toLowerCase();
    }

    function toggleDetailColor(element, color) {
      element.classList.toggle('selected');
      const idx = detailSelectedLabels.indexOf(color);
      if (idx > -1) detailSelectedLabels.splice(idx, 1);
      else detailSelectedLabels.push(color);
    }

    function editCardField(field) {
      const valueDiv = document.getElementById(`detail${field.charAt(0).toUpperCase() + field.slice(1)}`);
      const inputElement = document.getElementById(`detail${field.charAt(0).toUpperCase() + field.slice(1)}Input`);

      if (!inputElement) return;

      // Labels: on affiche un "panel" plut√¥t qu'un input
      if (field === 'labels') {
        const panel = document.getElementById('detailLabelsInput');
        valueDiv.style.display = 'none';
        panel.style.display = 'block';
        return;
      }

      valueDiv.style.display = 'none';
      inputElement.style.display = 'block';
      inputElement.focus();
    }

    function saveCardField(event, field) {
      if (event && event.key !== 'Enter' && event.type !== 'blur') return;

      const card = cards.find(c => c.id === currentCardId);
      if (!card) return;

      const valueDiv = document.getElementById(`detail${field.charAt(0).toUpperCase() + field.slice(1)}`);
      const inputElement = document.getElementById(`detail${field.charAt(0).toUpperCase() + field.slice(1)}Input`);

      if (field === 'title') {
        const v = inputElement.value.trim();
        if (v) {
          card.title = v;
          document.getElementById('detailCardTitle').textContent = v;
          valueDiv.textContent = v;
        }
      } else if (field === 'description') {
        card.description = inputElement.value.trim();
        valueDiv.textContent = card.description || '(Vide)';
        valueDiv.className = card.description ? 'card-detail-value' : 'card-detail-value empty';
      } else if (field === 'dueDate') {
        card.dueDate = inputElement.value;
        valueDiv.textContent = card.dueDate || '(Pas de date)';
        valueDiv.className = card.dueDate ? 'card-detail-value' : 'card-detail-value empty';
      } else if (field === 'address') {
        card.address = inputElement.value.trim();

        if (window.detailAddressCoordinates) {
          card.coordinates = window.detailAddressCoordinates;
          window.detailAddressCoordinates = null;
        }

        valueDiv.textContent = card.address || '(Aucune adresse)';
        valueDiv.className = card.address ? 'card-detail-value' : 'card-detail-value empty';

        document.getElementById('detailAddressAutocomplete').style.display = 'none';

        // Mise √† jour des deux cartes
        renderMapMarkers({ fit: true, reason: 'editAddress' });
        if (detailMiniMap) renderDetailMiniMarkers(card.id);
      } else if (field === 'labels') {
        card.labels = [...detailSelectedLabels];
        renderDetailLabels(card);

        document.getElementById('detailLabelsInput').style.display = 'none';
        document.getElementById('detailLabels').style.display = 'flex';
      }

      if (field !== 'labels') {
        card.history.push({ action: `${field} modifi√©`, timestamp: new Date().toLocaleString('fr-FR') });
      }

      saveData();
      renderBoard();

      if (field !== 'labels') {
        inputElement.style.display = 'none';
        valueDiv.style.display = 'flex';
      }
    }

    function deleteCard() {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette carte ?')) return;

      cards = cards.filter(c => c.id !== currentCardId);
      saveData();
      renderBoard();

      // Si on supprime le dernier marqueur, on garde la carte affich√©e telle quelle
      renderMapMarkers({ fit: true, reason: 'deleteCard' });

      closeCardDetailModal();
    }

    // -------------------------
    // Checklist + history
    // -------------------------
    function renderChecklist(card) {
      const container = document.getElementById('checklistContainer');
      container.innerHTML = '';

      (card.checklist || []).forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!item.completed;
        checkbox.onchange = () => {
          item.completed = checkbox.checked;
          card.history.push({
            action: `Item checklist: "${item.text}" ${item.completed ? 'coch√©' : 'd√©coch√©'}`,
            timestamp: new Date().toLocaleString('fr-FR')
          });
          saveData();
          renderChecklist(card);
          renderHistory(card);
        };

        const text = document.createElement('div');
        text.className = 'checklist-item-text';
        text.textContent = item.text;

        const del = document.createElement('button');
        del.className = 'checklist-item-delete';
        del.textContent = 'Supprimer';
        del.onclick = () => {
          card.checklist.splice(index, 1);
          card.history.push({
            action: `Item checklist supprim√©: "${item.text}"`,
            timestamp: new Date().toLocaleString('fr-FR')
          });
          saveData();
          renderChecklist(card);
          renderHistory(card);
        };

        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(text);
        itemDiv.appendChild(del);
        container.appendChild(itemDiv);
      });
    }

    function addChecklistItem() {
      const card = cards.find(c => c.id === currentCardId);
      if (!card) return;

      const text = prompt("Entrez l'item de la checklist:");
      if (!text || !text.trim()) return;

      card.checklist = card.checklist || [];
      card.checklist.push({ text: text.trim(), completed: false });
      card.history.push({ action: `Item checklist ajout√©: "${text.trim()}"`, timestamp: new Date().toLocaleString('fr-FR') });
      saveData();
      renderChecklist(card);
      renderHistory(card);
    }

    function renderHistory(card) {
      const container = document.getElementById('historyContainer');
      container.innerHTML = '';

      if (!card.history || card.history.length === 0) {
        container.innerHTML = '<div class="history-item">Aucun historique</div>';
        return;
      }

      card.history.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div class="history-action">${entry.action}</div><div class="history-time">${entry.timestamp}</div>`;
        container.appendChild(item);
      });
    }

    // -------------------------
    // Address autocomplete (Add modal)
    // -------------------------
    function searchAddress(query) {
      clearTimeout(addressSearchTimeout);
      if (!query || query.length < 2) {
        document.getElementById('addressAutocomplete').style.display = 'none';
        return;
      }
      addressSearchTimeout = setTimeout(() => performAddressSearch(query), 500);
    }

    async function performAddressSearch(query) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        const results = await response.json();

        const ac = document.getElementById('addressAutocomplete');
        ac.innerHTML = '';
        if (!results || results.length === 0) { ac.style.display = 'none'; return; }

        results.forEach(r => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = r.display_name;
          item.onclick = () => {
            document.getElementById('cardAddressInput').value = r.display_name;
            window.currentAddressCoordinates = { lat: parseFloat(r.lat), lon: parseFloat(r.lon) };
            ac.style.display = 'none';
          };
          ac.appendChild(item);
        });

        ac.style.display = 'block';
      } catch (e) {
        console.error(e);
      }
    }

    // -------------------------
    // Address autocomplete (Detail modal)
    // -------------------------
    function searchDetailAddress(query) {
      clearTimeout(detailAddressSearchTimeout);
      if (!query || query.length < 2) {
        document.getElementById('detailAddressAutocomplete').style.display = 'none';
        return;
      }
      detailAddressSearchTimeout = setTimeout(() => performDetailAddressSearch(query), 500);
    }

    async function performDetailAddressSearch(query) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        const results = await response.json();

        const ac = document.getElementById('detailAddressAutocomplete');
        ac.innerHTML = '';
        if (!results || results.length === 0) { ac.style.display = 'none'; return; }

        results.forEach(r => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = r.display_name;

          item.onclick = () => {
            const input = document.getElementById('detailAddressInput');
            input.value = r.display_name;
            window.detailAddressCoordinates = { lat: parseFloat(r.lat), lon: parseFloat(r.lon) };
            ac.style.display = 'none';

            const card = cards.find(c => c.id === currentCardId);
            if (!card) return;

            card.address = r.display_name;
            card.coordinates = { lat: parseFloat(r.lat), lon: parseFloat(r.lon) };
            card.history.push({ action: 'Adresse modifi√©e via auto-compl√©tion', timestamp: new Date().toLocaleString('fr-FR') });

            saveData();

            document.getElementById('detailAddress').textContent = card.address;
            document.getElementById('detailAddress').className = 'card-detail-value';

            // FitBounds auto (y compris si 0 -> 1 point)
            renderMapMarkers({ fit: true, reason: 'detailAutocomplete' });
            if (detailMiniMap) renderDetailMiniMarkers(card.id);

            renderBoard();
          };

          ac.appendChild(item);
        });

        ac.style.display = 'block';
      } catch (e) {
        console.error(e);
      }
    }

    // -------------------------
    // Main map (big)
    // -------------------------
    function initMap() {
      map = L.map('map');

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);

      // Restaurer la derni√®re position de carte si existante
      const savedView = getSavedMapView();
      if (savedView) {
        map.setView([savedView.lat, savedView.lng], savedView.zoom);
      } else {
        map.setView(DEFAULT_MAP_CENTER, DEFAULT_MAP_ZOOM);
      }

      // Persist map view
      map.on('moveend zoomend', () => saveMapView());

      // Recherche
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchMapLocation(document.getElementById('searchInput').value);
      });
    }

    function getSavedMapView() {
      try {
        const raw = localStorage.getItem(STORAGE_MAP_VIEW);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj.lat !== 'number' || typeof obj.lng !== 'number' || typeof obj.zoom !== 'number') return null;
        return obj;
      } catch {
        return null;
      }
    }

    function saveMapView() {
      if (!map) return;
      const c = map.getCenter();
      const z = map.getZoom();
      localStorage.setItem(STORAGE_MAP_VIEW, JSON.stringify({ lat: c.lat, lng: c.lng, zoom: z }));
    }

    function searchMapLocation(query) {
      if (!query || query.length < 2) return;

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
        .then(r => r.json())
        .then(results => {
          if (results && results.length > 0) {
            map.setView([parseFloat(results[0].lat), parseFloat(results[0].lon)], 13);
          }
        })
        .catch(console.error);
    }

    function clearMapMarkersOnly() {
      markersHidden = !markersHidden;
      if (markersHidden) {
        markersLayer.clearLayers();
      } else {
        renderMapMarkers({ fit: false, reason: 'unhideMarkers' });
      }
    }

    function getCardsWithCoords() {
      return cards.filter(c => c.coordinates && typeof c.coordinates.lat === 'number' && typeof c.coordinates.lon === 'number');
    }

    function renderMapMarkers({ fit, reason } = { fit: false, reason: 'unknown' }) {
      if (!map || !markersLayer) return;

      // Nettoyage
      markersLayer.clearLayers();
      markers = {};

      if (markersHidden) {
        // On ne recr√©e pas les markers visuels, mais on garde la logique fitBounds inactive
        lastMarkerCount = 0;
        return;
      }

      const cardsWithCoords = getCardsWithCoords();
      const count = cardsWithCoords.length;

      cardsWithCoords.forEach(card => {
        const m = L.marker([card.coordinates.lat, card.coordinates.lon]);

        const popupHtml = `
          <strong>${escapeHtml(card.title)}</strong><br>
          ${card.description ? escapeHtml(card.description) + '<br>' : ''}
          ${card.address ? 'üìç ' + escapeHtml(card.address) + '<br>' : ''}
          ${card.dueDate ? 'üìÖ ' + escapeHtml(card.dueDate) : ''}
        `;

        m.bindPopup(popupHtml);
        m.addTo(markersLayer);
        markers[card.id] = m;
      });

      const hadZeroBefore = (lastMarkerCount === 0);
      lastMarkerCount = count;

      // FitBounds "intelligent" :
      // - au chargement (fit:true)
      // - apr√®s modifications (fit:true)
      // - et surtout quand on passe de 0 -> >0
      if (count > 0 && (fit || hadZeroBefore)) {
        fitMapToMarkers(false);
      }
    }

    function fitMapToMarkers(animate) {
      if (!map) return;
      const cardsWithCoords = getCardsWithCoords();
      if (cardsWithCoords.length === 0) return; // garder la carte telle quelle

      const bounds = L.latLngBounds(cardsWithCoords.map(c => [c.coordinates.lat, c.coordinates.lon]));
      map.fitBounds(bounds, { padding: FIT_PADDING, maxZoom: FIT_MAX_ZOOM, animate: !!animate });
    }

    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // -------------------------
    // Mini-map (detail modal)
    // -------------------------
    function initOrUpdateDetailMiniMap(card) {
      const container = document.getElementById('detailMiniMapContainer');
      container.style.display = 'block';

      if (!detailMiniMap) {
        detailMiniMap = L.map('detailMiniMap').setView(DEFAULT_MAP_CENTER, DEFAULT_MAP_ZOOM);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(detailMiniMap);

        detailMiniMarkersLayer = L.layerGroup().addTo(detailMiniMap);
      }

      // Important dans un modal : recalcul de taille une fois visible
      setTimeout(() => detailMiniMap.invalidateSize(), 200);

      renderDetailMiniMarkers(card.id);
    }

    function renderDetailMiniMarkers(focusedCardId) {
      if (!detailMiniMap || !detailMiniMarkersLayer) return;

      detailMiniMarkersLayer.clearLayers();
      detailMiniCurrentMarker = null;

      const cardsWithCoords = getCardsWithCoords();
      let focusLatLng = null;

      cardsWithCoords.forEach(c => {
        const lat = c.coordinates.lat;
        const lon = c.coordinates.lon;
        const isCurrent = c.id === focusedCardId;

        let markerOptions = {};
        if (isCurrent) {
          const bigIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconSize: [35, 57],
            iconAnchor: [17, 56],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            shadowSize: [41, 41],
            shadowAnchor: [12, 41]
          });
          markerOptions.icon = bigIcon;
          focusLatLng = [lat, lon];
        }

        const marker = L.marker([lat, lon], markerOptions);

        const popupHtml = `
          <strong>${escapeHtml(c.title)}</strong><br>
          ${c.description ? escapeHtml(c.description) + '<br>' : ''}
          ${c.address ? 'üìç ' + escapeHtml(c.address) + '<br>' : ''}
          ${c.dueDate ? 'üìÖ ' + escapeHtml(c.dueDate) : ''}
        `;

        marker.bindPopup(popupHtml);

        marker.on('click', () => {
          // Mini-map se recentre, grande carte ne bouge pas
          detailMiniMap.setView([lat, lon], 13);
          marker.openPopup();
        });

        marker.addTo(detailMiniMarkersLayer);

        if (isCurrent) detailMiniCurrentMarker = marker;
      });

      if (focusLatLng) {
        detailMiniMap.setView(focusLatLng, 13);
      } else if (cardsWithCoords.length > 0) {
        const bounds = L.latLngBounds(cardsWithCoords.map(c => [c.coordinates.lat, c.coordinates.lon]));
        detailMiniMap.fitBounds(bounds, { padding: [20,20], maxZoom: FIT_MAX_ZOOM });
      }
    }

    // -------------------------
    // Vue Board/Map persist√©e
    // -------------------------
    function restoreLastView() {
      const saved = localStorage.getItem(STORAGE_ACTIVE_VIEW) || 'board';
      switchView(saved, { fromInit: true });
    }

    function switchView(view, opts = { fromInit: false }) {
      const boardSection = document.getElementById('boardSection');
      const mapSection = document.getElementById('mapSection');

      const btnBoard = document.getElementById('btnViewBoard');
      const btnMap = document.getElementById('btnViewMap');

      btnBoard.classList.remove('active');
      btnMap.classList.remove('active');

      if (view === 'map') {
        boardSection.classList.remove('active');
        mapSection.classList.add('active');
        btnMap.classList.add('active');
      } else {
        mapSection.classList.remove('active');
        boardSection.classList.add('active');
        btnBoard.classList.add('active');
      }

      localStorage.setItem(STORAGE_ACTIVE_VIEW, view);

      if (view === 'map') {
        // Apr√®s affichage (container size change)
        setTimeout(() => {
          map && map.invalidateSize();
          // Si on a des marqueurs, un fitBounds est possible (sinon on garde la vue)
          renderMapMarkers({ fit: false, reason: 'switchView' });
        }, 250);
      }
    }

    // -------------------------
    // Supprimer toutes les cartes (test)
    // -------------------------
    function deleteAllCards() {
      if (!confirm('Supprimer toutes les cartes ?')) return;

      cards = [];
      saveData();
      renderBoard();

      // Map reste affich√©e, juste sans marqueurs
      renderMapMarkers({ fit: true, reason: 'deleteAll' });

      // Si la mini-carte √©tait ouverte, on la rafra√Æchit aussi
      if (detailMiniMap) {
        detailMiniMarkersLayer && detailMiniMarkersLayer.clearLayers();
      }
    }

    // -------------------------
    // Click outside modals
    // -------------------------
    window.onclick = (event) => {
      const addListModal = document.getElementById('addListModal');
      const addCardModal = document.getElementById('addCardModal');
      const cardDetailModal = document.getElementById('cardDetailModal');
      const deleteListModal = document.getElementById('deleteListModal');

      const addressAutocomplete = document.getElementById('addressAutocomplete');

      if (event.target === addListModal) closeAddListModal();
      if (event.target === addCardModal) closeAddCardModal();
      if (event.target === cardDetailModal) closeCardDetailModal();
      if (event.target === deleteListModal) closeDeleteListModal();

      if (!event.target.closest('.form-group-relative') && addressAutocomplete) {
        addressAutocomplete.style.display = 'none';
      }
      // autocomplete du d√©tail: volontairement non auto-ferm√©
    };

    // -------------------------
    // Boot
    // -------------------------
    window.onload = init;
  </script>
</body>
</html>
