<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Trello Clone avec Carte</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- App CSS -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="navbar">
    <div class="navbar-brand">
      <i class="fas fa-trello"></i>
      <span>Trello Clone</span>
    </div>

    <div class="navbar-controls">
      <div class="view-toggle">
        <button id="btnViewBoard" class="active" onclick="switchView('board')">
          <i class="fas fa-th"></i> Board
        </button>
        <button id="btnViewMap" onclick="switchView('map')">
          <i class="fas fa-map"></i> Map
        </button>
      </div>

      <div class="dropdown" id="navbarOptionsDropdown">
        <button class="dropdown-toggle" onclick="toggleNavbarOptionsMenu()">
          <i class="fas fa-ellipsis-h"></i>
        </button>
        <div class="dropdown-menu" id="navbarOptionsMenu">
          <div class="dropdown-item" onclick="openLabelsManagementModal(); closeNavbarOptionsMenu();">
            <i class="fas fa-tags"></i> Gérer les étiquettes
          </div>
          <div class="dropdown-item" onclick="openAddListModal(); closeNavbarOptionsMenu();">
            <i class="fas fa-plus"></i> Ajouter une liste
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="board-section active" id="boardSection">
      <div class="board-content" id="boardContent">
        <div class="add-list-btn" onclick="openAddListModal()">
          <i class="fas fa-plus"></i> Ajouter une liste
        </div>
      </div>
    </div>

    <div class="map-section" id="mapSection">
      <div id="map"></div>
      <div class="map-controls">
        <input type="text" id="searchInput" placeholder="Rechercher un lieu...">
        <button class="btn btn-primary" onclick="fitMapToMarkers(true)">
          <i class="fas fa-crosshairs"></i> Recentrer sur les marqueurs
        </button>
        <button class="btn btn-secondary" onclick="clearMapMarkersOnly()">
          <i class="fas fa-eraser"></i> Masquer les marqueurs (visuel)
        </button>
      </div>
    </div>
  </div>

  <!-- Add List Modal -->
  <div class="modal" id="addListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ajouter une liste</h2>
        <button class="close-modal" onclick="closeAddListModal()">&times;</button>
      </div>
      <div class="form-group">
        <label for="listNameInput">Nom de la liste:</label>
        <input type="text" id="listNameInput" placeholder="Entrez le nom de la liste">
      </div>
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveNewList()">Créer</button>
        <button class="btn-cancel" onclick="closeAddListModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Delete List Modal -->
  <div class="modal" id="deleteListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Supprimer la liste</h2>
        <button class="close-modal" onclick="closeDeleteListModal()">&times;</button>
      </div>
      <p id="deleteListMessage" style="margin-bottom: 20px;"></p>
      <div class="modal-buttons">
        <button class="btn-save" onclick="moveCardsToArchives()">Déplacer vers Archives</button>
        <button class="btn-danger" onclick="deleteCardsAndList()">Supprimer toutes les cartes</button>
        <button class="btn-cancel" onclick="closeDeleteListModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Add Card Modal -->
  <div class="modal" id="addCardModal">
    <div class="modal-content">
      <!-- Cover Image Preview for Add Card -->
      <div id="addCardCoverImageContainer" class="cover-image-container" style="display:none;">
        <img id="addCardCoverImage" class="cover-image" src="" alt="Cover image">
      </div>

      <div class="modal-header">
        <h2 id="cardModalTitle">Ajouter une carte</h2>
        <button class="close-modal" onclick="closeAddCardModal()">&times;</button>
      </div>

      <!-- Image Search Section for Add Card -->
      <div class="card-detail-section">
        <div class="card-detail-field">
          <label><i class="fas fa-image"></i> Image de couverture</label>
          <div class="image-search-container">
            <input type="text" class="card-detail-input" id="addCardImageSearchInput" placeholder="Rechercher une image (ex: Tour Eiffel, restaurant, plage...)" autocomplete="off">
            <button class="btn btn-primary image-search-btn" onclick="searchAddCardImages()">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div id="addCardImageSearchResults" class="image-search-results" style="display:none;"></div>

          <!-- Alternative image options -->
          <div class="image-alternative-options">
            <div class="image-alt-divider"><span>ou</span></div>
            <div class="image-alt-buttons">
              <button type="button" class="btn btn-secondary image-alt-btn" onclick="document.getElementById('addCardImageFileInput').click()">
                <i class="fas fa-upload"></i> Importer une image
              </button>
              <button type="button" class="btn btn-secondary image-alt-btn" onclick="toggleUrlInput('addCard')">
                <i class="fas fa-link"></i> Coller un lien
              </button>
            </div>
            <input type="file" id="addCardImageFileInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this, 'addCard')">
            <div id="addCardUrlInputContainer" class="image-url-input-container" style="display:none;">
              <input type="text" class="card-detail-input" id="addCardImageUrlInput" placeholder="Collez l'URL de l'image ici...">
              <button class="btn btn-primary" onclick="applyImageUrl('addCard')">Appliquer</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Titre</label>
          <input type="text" class="card-detail-input" id="cardTitleInput" placeholder="Entrez le titre de la carte">
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Description</label>
          <textarea class="card-detail-input" id="cardDescriptionInput" placeholder="Entrez la description" style="min-height:100px;"></textarea>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Étiquettes</label>
          <div class="label-selector" id="addCardLabelSelector">
            <div class="selected-labels" id="addCardSelectedLabels"></div>
            <input type="text" class="card-detail-input label-search-input" id="addCardLabelSearch"
                   placeholder="Rechercher ou voir toutes les étiquettes..."
                   oninput="handleAddCardLabelSearch()"
                   onfocus="renderAddCardLabelSelector()"
                   autocomplete="off">
            <div class="label-suggestions" id="addCardLabelSuggestions"></div>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Date d'échéance</label>
          <input type="date" class="card-detail-input" id="cardDueDateInput">
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Adresse</label>
          <div class="form-group-relative">
            <input type="text" class="card-detail-input" id="cardAddressInput" placeholder="Entrez une adresse" autocomplete="off" oninput="searchAddress(this.value)">
            <div id="addressAutocomplete" class="autocomplete-list" style="display:none;"></div>
          </div>
          <div id="addCardMiniMapContainer" style="display:none;">
            <div id="addCardMiniMap"></div>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <label style="font-weight:700;color:#333;font-size:14px;">Checklist</label>
        <div class="checklist-section" id="addCardChecklistContainer"></div>
        <div class="add-checklist-item" onclick="addCardChecklistItem()">+ Ajouter un item</div>
      </div>

      <div class="modal-buttons">
        <button class="btn-save" onclick="saveNewCard()">Créer la carte</button>
      </div>
    </div>
  </div>

  <!-- Card Detail Modal -->
  <div class="modal" id="cardDetailModal">
    <div class="modal-content">
      <!-- Cover Image -->
      <div id="detailCoverImageContainer" class="cover-image-container" style="display:none;">
        <img id="detailCoverImage" class="cover-image" src="" alt="Cover image">
      </div>

      <div class="modal-header">
        <h2 id="detailCardTitle">Détails de la carte</h2>
        <div class="modal-header-actions">
          <div class="dropdown" id="cardOptionsDropdown">
            <button class="dropdown-toggle" onclick="toggleCardOptionsMenu()">
              <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="dropdown-menu" id="cardOptionsMenu">
              <div class="dropdown-item" onclick="openLabelsManagementModal()">
                <i class="fas fa-tags"></i> Gérer les étiquettes
              </div>
              <div class="dropdown-item" id="removeCoverImageOption" onclick="removeCoverImage(); closeCardOptionsMenu();" style="display:none;">
                <i class="fas fa-image"></i> Supprimer l'image de couverture
              </div>
              <div class="dropdown-item dropdown-item-danger" onclick="deleteCard()">
                <i class="fas fa-trash"></i> Supprimer la carte
              </div>
            </div>
          </div>
          <button class="close-modal" onclick="closeCardDetailModal()">&times;</button>
        </div>
      </div>

      <!-- Image Search Section -->
      <div class="card-detail-section">
        <div class="card-detail-field">
          <label><i class="fas fa-image"></i> Image de couverture</label>
          <div class="image-search-container">
            <input type="text" class="card-detail-input" id="imageSearchInput" placeholder="Rechercher une image (ex: Tour Eiffel, restaurant, plage...)" autocomplete="off">
            <button class="btn btn-primary image-search-btn" onclick="searchImages()">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div id="imageSearchResults" class="image-search-results" style="display:none;"></div>

          <!-- Alternative image options -->
          <div class="image-alternative-options">
            <div class="image-alt-divider"><span>ou</span></div>
            <div class="image-alt-buttons">
              <button type="button" class="btn btn-secondary image-alt-btn" onclick="document.getElementById('detailImageFileInput').click()">
                <i class="fas fa-upload"></i> Importer une image
              </button>
              <button type="button" class="btn btn-secondary image-alt-btn" onclick="toggleUrlInput('detail')">
                <i class="fas fa-link"></i> Coller un lien
              </button>
            </div>
            <input type="file" id="detailImageFileInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this, 'detail')">
            <div id="detailUrlInputContainer" class="image-url-input-container" style="display:none;">
              <input type="text" class="card-detail-input" id="detailImageUrlInput" placeholder="Collez l'URL de l'image ici...">
              <button class="btn btn-primary" onclick="applyImageUrl('detail')">Appliquer</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Titre</label>
          <div class="card-detail-value" id="detailTitle" onclick="editCardField('title')"></div>
          <input type="text" class="card-detail-input" id="detailTitleInput" style="display:none;" onkeydown="saveCardField(event,'title')">
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Description</label>
          <div class="card-detail-value" id="detailDescription" onclick="editCardField('description')"></div>
          <textarea class="card-detail-input" id="detailDescriptionInput" style="display:none;min-height:100px;"
            onkeydown="saveCardField(event,'description')"
            onblur="saveCardField({type:'blur'},'description')"></textarea>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Étiquettes</label>
          <div class="card-detail-value" id="detailLabels" onclick="editCardField('labels')" style="flex-wrap:wrap;gap:5px;"></div>
          <div id="detailLabelsInput" class="label-selector" style="display:none;">
            <div class="selected-labels" id="detailSelectedLabels"></div>
            <input type="text" class="card-detail-input label-search-input" id="detailLabelSearch"
                   placeholder="Rechercher ou voir toutes les étiquettes..."
                   oninput="handleDetailLabelSearch()"
                   onfocus="renderDetailLabelSelector()"
                   autocomplete="off">
            <div class="label-suggestions" id="detailLabelSuggestions"></div>
            <button class="btn btn-primary" style="margin-top:10px;width:100%;" onclick="saveCardField(null,'labels')">Valider</button>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Date d'échéance</label>
          <div class="card-detail-value" id="detailDate" onclick="editCardField('dueDate')"></div>
          <input type="date" class="card-detail-input" id="detailDateInput" style="display:none;"
                 onkeydown="saveCardField(event,'dueDate')"
                 onblur="saveCardField({type:'blur'},'dueDate')">
        </div>
      </div>

      <div class="card-detail-section">
        <div class="card-detail-field">
          <label>Adresse</label>
          <div class="card-detail-value" id="detailAddress" onclick="editCardField('address')" style="word-break:break-word;"></div>
          <div class="form-group-relative">
            <input type="text" class="card-detail-input" id="detailAddressInput" style="display:none;" autocomplete="off"
                   onkeydown="saveCardField(event,'address')" oninput="searchDetailAddress(this.value)">
            <div id="detailAddressAutocomplete" class="autocomplete-list" style="display:none;"></div>
          </div>

          <div id="detailMiniMapContainer" style="display:none;">
            <div id="detailMiniMap"></div>
          </div>
        </div>
      </div>

      <div class="card-detail-section">
        <label style="font-weight:700;color:#333;font-size:14px;">Checklist</label>
        <div class="checklist-section" id="checklistContainer"></div>
        <div class="add-checklist-item" onclick="addChecklistItem()">+ Ajouter un item</div>
      </div>

      <div class="card-detail-section">
        <label style="font-weight:700;color:#333;font-size:14px;">Historique</label>
        <div id="historyContainer" style="max-height:250px;overflow-y:auto;"></div>
      </div>

    </div>
  </div>

  <!-- Labels Management Modal -->
  <div class="modal" id="labelsManagementModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Gérer les étiquettes</h2>
        <button class="close-modal" onclick="closeLabelsManagementModal()">&times;</button>
      </div>

      <!-- Label Creation/Edit Form -->
      <div class="label-form-section">
        <h3 id="labelFormTitle">Nouvelle étiquette</h3>
        <div class="form-group">
          <label for="labelNameInput">Nom de l'étiquette</label>
          <input type="text" id="labelNameInput" placeholder="Ex: Restaurant, Shopping, À visiter...">
        </div>
        <div class="form-group">
          <label>Couleur</label>
          <div class="label-color-section">
            <div class="label-color-palette" id="labelColorPalette"></div>
            <div class="label-color-custom">
              <label for="labelColorInput">Ou choisir une couleur personnalisée :</label>
              <input type="color" id="labelColorInput" value="#FF6B6B" onchange="updatePaletteFromInput()">
            </div>
          </div>
        </div>
        <div class="label-form-buttons">
          <button class="btn btn-primary" id="saveLabelBtn" onclick="saveLabel()">Créer</button>
          <button class="btn btn-secondary" id="cancelEditBtn" style="display:none;" onclick="cancelEditLabel()">Annuler</button>
        </div>
      </div>

      <!-- Existing Labels List -->
      <div class="labels-list-section">
        <h3>Étiquettes existantes</h3>
        <div id="labelsManagementList" class="labels-management-list"></div>
      </div>
    </div>
  </div>

  <!-- External JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- App JS -->
  <script src="app.js"></script>
</body>
</html>
